<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìì–‘ë™ ì‹¤ì‹œê°„ ì‹œì„¸ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        /* Navigation */
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .nav a {
            padding: 10px 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .nav a:hover, .nav a.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
        }
        h1 {
            font-size: 1.8rem;
            color: var(--text);
            margin-bottom: 10px;
            font-weight: 700;
        }
        .subtitle { color: var(--text-muted); font-size: 0.95rem; }
        .live-badge {
            display: inline-block;
            background: var(--success);
            color: #fff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        select, input {
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s;
        }
        select:hover, input:hover {
            border-color: #cbd5e1;
        }
        select:focus, input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        button {
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            background: var(--primary);
            color: #fff;
            border: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        button:hover {
            background: var(--primary-light);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: var(--card);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover {
            background: var(--bg);
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 1200px) {
            .grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
        }

        /* Stat Card */
        .stat-card {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        .stat-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 5px;
        }
        .stat-sub {
            color: #94a3b8;
            font-size: 0.75rem;
            margin-top: 3px;
        }

        /* Card */
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }
        .card h2 {
            font-size: 1rem;
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg);
        }
        td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        tr:hover {
            background: var(--bg);
        }
        .highlight { color: var(--primary); font-weight: 600; }
        .highlight-green { color: var(--success); font-weight: 600; }
        .highlight-purple { color: #7c3aed; font-weight: 600; }
        .highlight-yellow { color: var(--warning); font-weight: 600; }
        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .tag-open { background: rgba(16,185,129,0.1); color: var(--success); }
        .tag-closed { background: rgba(100,116,139,0.1); color: var(--text-muted); }

        /* Chart Container */
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        @media (max-width: 900px) {
            .chart-row { grid-template-columns: 1fr; }
        }
        .chart-container {
            height: 250px;
            position: relative;
        }

        /* Bar Chart (CSS only) */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            height: 200px;
            padding: 20px 0;
        }
        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .bar {
            width: 100%;
            max-width: 80px;
            border-radius: 6px 6px 0 0;
            background: var(--primary);
            transition: height 0.5s ease;
        }
        .bar-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
        }
        .bar-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
        }

        /* Pie Chart (CSS only) */
        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text);
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-muted);
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .empty-state p { margin-top: 10px; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--card);
            border: 1px solid var(--border);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            color: var(--text);
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid #ef4444; }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 40px;
        }
        footer a { color: var(--primary); text-decoration: none; }

        /* Filter buttons */
        .filter-btn {
            padding: 8px 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        /* Leaflet ìŠ¤íƒ€ì¼ */
        .leaflet-container { background: #e8e8e8; }
        .leaflet-popup-content-wrapper {
            background: #fff;
            color: #333;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 5px;
        }
        .leaflet-popup-tip { background: #fff; }
        .leaflet-popup-content { margin: 10px 12px; }
        .leaflet-control-zoom a {
            background: rgba(255,255,255,0.9) !important;
            color: #333 !important;
        }
    </style>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="nav">
            <a href="index.html" class="active">ì‹¤ì‹œê°„ ì‹œì„¸</a>
            <a href="broker.html">ê³µì¸ì¤‘ê°œì‚¬</a>
            <a href="analysis.html">ì„ëŒ€ ë¶„ì„</a>
            <a href="sangwon_analysis.html">ìƒê¶Œ ë¶„ì„</a>
            <a href="report.html">ì „ëµ ë³´ê³ ì„œ</a>
        </nav>

        <!-- Header -->
        <header>
            <h1>ìì–‘ë™ ì‹¤ì‹œê°„ ì‹œì„¸ ëŒ€ì‹œë³´ë“œ <span class="live-badge">LIVE</span></h1>
            <p class="subtitle">ìì–‘ë™ ìƒê°€ ì›”ì„¸/ë§¤ë§¤ ì‹¤ê±°ë˜ ë°ì´í„°</p>
        </header>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label>ì§€ì—­ ì„ íƒ</label>
                <select id="areaSelect">
                    <option value="jayang_station">ìì–‘ì—­ ì¸ê·¼</option>
                    <option value="jayang_wide">ìì–‘ë™ ì „ì²´</option>
                    <option value="konkuk">ê±´ëŒ€ì…êµ¬ì—­</option>
                    <option value="custom">ì§ì ‘ ì…ë ¥</option>
                </select>
            </div>
            <div class="control-group" id="customCoords" style="display:none;">
                <label>ì¢Œí‘œ (NE Lat, NE Lng, SW Lat, SW Lng)</label>
                <input type="text" id="coordsInput" placeholder="37.535, 127.068, 37.532, 127.064" style="width:300px;">
            </div>
            <div class="control-group">
                <label>&nbsp;</label>
                <button id="fetchBtn" onclick="fetchData()">ë°ì´í„° ì¡°íšŒ</button>
            </div>
            <div class="control-group">
                <label>&nbsp;</label>
                <button class="btn-secondary" onclick="exportCSV()">CSV ë‚´ë³´ë‚´ê¸°</button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ </div>
                <div class="stat-value" id="statDeposit">-</div>
                <div class="stat-label">í‰ê·  ë³´ì¦ê¸ˆ</div>
                <div class="stat-sub">ê³µê°œ ë§¤ë¬¼ ê¸°ì¤€</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-value" id="statRent">-</div>
                <div class="stat-label">í‰ê·  ì›”ì„¸</div>
                <div class="stat-sub">ê³µê°œ ë§¤ë¬¼ ê¸°ì¤€</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“</div>
                <div class="stat-value" id="statPrice">-</div>
                <div class="stat-label">í‰ë‹¹ ì›”ì„¸</div>
                <div class="stat-sub">ë§Œì›/í‰</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-value" id="statCount">-</div>
                <div class="stat-label">ë°ì´í„° ê±´ìˆ˜</div>
                <div class="stat-sub">í•´ë‹¹ ì˜ì—­ ë‚´</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="chart-row">
            <!-- Floor Price Chart -->
            <div class="card">
                <h2>ğŸ“Š ì¸µë³„ í‰ë‹¹ê°€</h2>
                <div class="bar-chart" id="floorChart">
                    <div class="empty-state">ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”</div>
                </div>
            </div>

            <!-- Business Distribution -->
            <div class="card">
                <h2>ğŸª ì—…ì¢… ë¶„í¬</h2>
                <div id="businessChart">
                    <div class="empty-state">ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”</div>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="card">
            <h2>ğŸ—ºï¸ ë§¤ë¬¼ ìœ„ì¹˜</h2>
            <div style="position:relative;">
                <div id="map" style="height:450px;border-radius:12px;"></div>
                <!-- ë²”ë¡€ -->
                <div style="position:absolute;bottom:20px;left:20px;background:#fff;border:1px solid #e2e8f0;padding:12px 16px;border-radius:10px;font-size:0.8rem;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                    <div style="margin-bottom:8px;font-weight:600;color:#1e293b;">ì¸µë³„ ìƒ‰ìƒ</div>
                    <div style="display:flex;gap:15px;flex-wrap:wrap;color:#64748b;">
                        <span><span style="display:inline-block;width:12px;height:12px;background:#f59e0b;border-radius:50%;margin-right:5px;"></span>ì§€í•˜</span>
                        <span><span style="display:inline-block;width:12px;height:12px;background:#10b981;border-radius:50%;margin-right:5px;"></span>1ì¸µ</span>
                        <span><span style="display:inline-block;width:12px;height:12px;background:#a855f7;border-radius:50%;margin-right:5px;"></span>2ì¸µ+</span>
                        <span style="color:#94a3b8;">| íˆ¬ëª… = ê±°ë˜ì™„ë£Œ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Listings Table -->
        <div class="card">
            <h2>ğŸ¢ ì›”ì„¸ ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ <span id="listingCount" style="font-size:0.8rem;color:#888;font-weight:normal;"></span></h2>

            <!-- ì¸µ í•„í„° -->
            <div style="margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                <span style="color:#888;font-size:0.9rem;">ì¸µ í•„í„°:</span>
                <button class="filter-btn active" data-floor="all" onclick="filterByFloor('all')">ì „ì²´</button>
                <button class="filter-btn" data-floor="basement" onclick="filterByFloor('basement')">ì§€í•˜</button>
                <button class="filter-btn" data-floor="1" onclick="filterByFloor('1')">1ì¸µ</button>
                <button class="filter-btn" data-floor="upper" onclick="filterByFloor('upper')">2ì¸µ ì´ìƒ</button>
                <span id="filterStats" style="margin-left:20px;color:#00d4ff;font-size:0.85rem;"></span>
            </div>

            <div id="listingsTable">
                <div class="empty-state">
                    <p>ğŸ‘† ìƒë‹¨ì—ì„œ ì§€ì—­ì„ ì„ íƒí•˜ê³  [ë°ì´í„° ì¡°íšŒ]ë¥¼ í´ë¦­í•˜ì„¸ìš”</p>
                </div>
            </div>
            <div id="pagination" style="margin-top:20px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;"></div>
        </div>

        <!-- Quarterly Trend -->
        <div class="card">
            <h2>ğŸ“ˆ ë¶„ê¸°ë³„ ê±°ë˜ ì¶”ì´</h2>
            <div id="quarterlyTable">
                <div class="empty-state">ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”</div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>ìì–‘ë™ ìƒê°€ ì‹¤ì‹œê°„ ì‹œì„¸ ëŒ€ì‹œë³´ë“œ | ë¶„ì„ì¼: 2026-01-21</p>
        </footer>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // ì„¤ì •
        // ============================================

        // JWT í† í° (ë§Œë£Œ ì‹œ êµì²´ í•„ìš”)
        const TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjFkY2I5MmY3LTE3NDctNGRlOS05MmNmLTU3YTE0MTQ4ZDZjNCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWUiOiJvanNveW1Aa2FrYW8uY29tIiwibmJmIjoxNzY4ODE2NDM4LCJleHAiOjE3NzE0MDg0MzgsImlzcyI6IlN1Z2FyaGlsbCIsImF1ZCI6Ik5lbW8ifQ.7wqXMZ8uUTk2A-Iy4bijznUmAdRxE3YSOc6huqRAxcQ";

        // ì§€ì—­ í”„ë¦¬ì…‹
        const AREA_PRESETS = {
            jayang_station: { NELat: 37.534899, NELng: 127.069327, SWLat: 37.532840, SWLng: 127.065889, name: "ìì–‘ì—­ ì¸ê·¼" },
            jayang_wide: { NELat: 37.545, NELng: 127.075, SWLat: 37.525, SWLng: 127.050, name: "ìì–‘ë™ ì „ì²´" },
            konkuk: { NELat: 37.545, NELng: 127.075, SWLat: 37.538, SWLng: 127.065, name: "ê±´ëŒ€ì…êµ¬ì—­" }
        };

        // ì €ì¥ëœ ë°ì´í„°
        let currentData = null;
        let currentPage = 1;
        let currentFloorFilter = 'all';
        const ITEMS_PER_PAGE = 15;
        let map = null;

        // ============================================
        // UI ì´ë²¤íŠ¸
        // ============================================

        document.getElementById('areaSelect').addEventListener('change', function() {
            document.getElementById('customCoords').style.display =
                this.value === 'custom' ? 'block' : 'none';
        });

        // ============================================
        // API í˜¸ì¶œ
        // ============================================

        async function fetchAPI(endpoint, params) {
            const query = Object.entries(params).map(([k,v]) => `${k}=${v}`).join('&');
            const url = `https://www.nemoapp.kr${endpoint}?${query}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `bearer ${TOKEN}`,
                        'Accept': 'application/json',
                        'Referer': 'https://www.nemoapp.kr/datalab'
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function fetchData() {
            const btn = document.getElementById('fetchBtn');
            btn.disabled = true;
            btn.textContent = 'ì¡°íšŒ ì¤‘...';

            try {
                // ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸°
                const areaSelect = document.getElementById('areaSelect').value;
                let coords;

                if (areaSelect === 'custom') {
                    const input = document.getElementById('coordsInput').value.split(',').map(s => parseFloat(s.trim()));
                    if (input.length !== 4) throw new Error('ì¢Œí‘œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
                    coords = { NELat: input[0], NELng: input[1], SWLat: input[2], SWLng: input[3] };
                } else {
                    coords = AREA_PRESETS[areaSelect];
                }

                // API í˜¸ì¶œ
                const [stats, listings, count] = await Promise.all([
                    fetchAPI('/api/datalab/map/search', { ...coords, Zoom: 1 }),
                    fetchAPI('/api/datalab/map/grid', { ...coords, Zoom: 19 }),
                    fetchAPI('/api/datalab/map/count', { ...coords, Zoom: 1 })
                ]);

                currentData = { stats, listings, count, coords };

                // UI ì—…ë°ì´íŠ¸
                updateStats(stats, count);
                updateFloorChart(listings);  // ê°œë³„ ë§¤ë¬¼ ê¸°ì¤€ ê³„ì‚°
                updateBusinessChart(stats.businessItems || []);
                updateListingsTable(listings || []);
                updateQuarterlyTable(stats.complateItems || []);

                showToast('ë°ì´í„° ì¡°íšŒ ì™„ë£Œ!', 'success');

            } catch (error) {
                showToast(`ì˜¤ë¥˜: ${error.message}`, 'error');
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ë°ì´í„° ì¡°íšŒ';
            }
        }

        // ============================================
        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
        // ============================================

        function updateStats(stats, count) {
            const pub = stats.publicItems || {};

            // ë‹¨ìœ„: ì›ë³¸ê°’ /10 = ì‹¤ì œ ë§Œì›
            const dep = (pub.avgDeposit || 0) / 10;
            const rent = (pub.avgMonthlyRent || 0) / 10;
            const price = (pub.avgAreaPrice || 0) / 10;

            document.getElementById('statDeposit').textContent =
                dep ? (dep >= 10000 ? `${(dep/10000).toFixed(1)}ì–µ` : `${dep.toLocaleString()}ë§Œ`) : '-';
            document.getElementById('statRent').textContent =
                rent ? `${Math.round(rent).toLocaleString()}ë§Œ` : '-';
            document.getElementById('statPrice').textContent =
                price ? `${price.toFixed(1)}ë§Œ` : '-';
            document.getElementById('statCount').textContent =
                count ? `${count}ê±´` : '-';
        }

        function updateFloorChart(listings) {
            const container = document.getElementById('floorChart');

            // ê°œë³„ ë§¤ë¬¼ ê¸°ì¤€ìœ¼ë¡œ ì¸µë³„ ì¤‘ì•™ê°’ ê³„ì‚°
            const floorData = { 'ì§€í•˜': [], '1ì¸µ': [], '2ì¸µ+': [] };

            (listings || []).forEach(building => {
                (building.items || []).forEach(item => {
                    const floor = item.floor || 0;
                    const price = item.areaPrice || 0;
                    if (price <= 0) return;

                    if (floor < 0) floorData['ì§€í•˜'].push(price);
                    else if (floor === 1) floorData['1ì¸µ'].push(price);
                    else if (floor >= 2) floorData['2ì¸µ+'].push(price);
                });
            });

            // ì¤‘ì•™ê°’ ê³„ì‚°
            const median = arr => {
                if (!arr.length) return 0;
                const sorted = [...arr].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            };

            const floorStats = [
                { floor: 'ì§€í•˜', price: median(floorData['ì§€í•˜']), count: floorData['ì§€í•˜'].length },
                { floor: '1ì¸µ', price: median(floorData['1ì¸µ']), count: floorData['1ì¸µ'].length },
                { floor: '2ì¸µ+', price: median(floorData['2ì¸µ+']), count: floorData['2ì¸µ+'].length }
            ].filter(f => f.count > 0);

            if (!floorStats.length) {
                container.innerHTML = '<div class="empty-state">ë°ì´í„° ì—†ìŒ</div>';
                return;
            }

            const maxPrice = Math.max(...floorStats.map(f => f.price));

            container.innerHTML = floorStats.map(item => `
                <div class="bar-item">
                    <div class="bar-value">${item.price.toFixed(1)}ë§Œ</div>
                    <div class="bar" style="height: ${(item.price / maxPrice) * 150}px;"></div>
                    <div class="bar-label">${item.floor} (${item.count})</div>
                </div>
            `).join('');
        }

        function updateBusinessChart(businessItems) {
            const container = document.getElementById('businessChart');

            if (!businessItems.length) {
                container.innerHTML = '<div class="empty-state">ë°ì´í„° ì—†ìŒ</div>';
                return;
            }

            const colors = ['#00d4ff', '#7c3aed', '#f472b6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            const top8 = businessItems.slice(0, 8);

            container.innerHTML = `
                <div class="pie-legend">
                    ${top8.map((item, i) => `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${colors[i % colors.length]}"></div>
                            <span>${item.businessMiddleCodeName} (${item.ratio}%)</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ê°œë³„ ë§¤ë¬¼ ë¦¬ìŠ¤íŠ¸ í‰íƒ„í™”
        function flattenItems(listings) {
            const items = [];
            listings.forEach(building => {
                const addr = building.roadAddress || building.address || '-';
                (building.items || []).forEach(item => {
                    items.push({ ...item, address: addr, building });
                });
            });
            return items;
        }

        function updateListingsTable(listings, page = 1) {
            const container = document.getElementById('listingsTable');
            const countEl = document.getElementById('listingCount');
            const paginationEl = document.getElementById('pagination');

            // ê°œë³„ ë§¤ë¬¼ë¡œ í‰íƒ„í™”
            const allItems = flattenItems(listings);

            if (!allItems.length) {
                container.innerHTML = '<div class="empty-state">ë§¤ë¬¼ ë°ì´í„° ì—†ìŒ</div>';
                countEl.textContent = '';
                paginationEl.innerHTML = '';
                return;
            }

            // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
            const totalPages = Math.ceil(allItems.length / ITEMS_PER_PAGE);
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = allItems.slice(start, end);

            countEl.textContent = `(ì´ ${allItems.length}ê°œ ë§¤ë¬¼)`;

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ì£¼ì†Œ</th>
                            <th>ë³´ì¦ê¸ˆ</th>
                            <th>ì›”ì„¸</th>
                            <th>í‰ë‹¹ê°€</th>
                            <th>ê¶Œë¦¬ê¸ˆ</th>
                            <th>ì¸µ</th>
                            <th>ë©´ì </th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageItems.map(item => {
                            const state = item.state === 1 ? 'open' : 'closed';
                            const stateText = item.stateName || (item.state === 1 ? 'ê´‘ê³ ì¤‘' : 'ê±°ë˜ì™„ë£Œ');
                            const date = item.completionConfirmedDateUtc ? item.completionConfirmedDateUtc.slice(0,10) : '';

                            const dep = item.deposit || 0;
                            const rent = item.monthlyRent || 0;
                            const price = item.areaPrice || 0;
                            const prem = item.premium || 0;
                            const size = item.size ? (item.size / 3.3058).toFixed(1) : '-';

                            const fmt = (v) => v >= 10000 ? (v/10000).toFixed(1) + 'ì–µ' : Math.round(v).toLocaleString() + 'ë§Œ';

                            return `
                                <tr>
                                    <td>${item.address}</td>
                                    <td class="highlight">${dep ? fmt(dep) : '-'}</td>
                                    <td class="highlight-green">${rent ? Math.round(rent) + 'ë§Œ' : '-'}</td>
                                    <td>${price ? price.toFixed(1) + 'ë§Œ/í‰' : '-'}</td>
                                    <td class="highlight-yellow">${prem ? fmt(prem) : '-'}</td>
                                    <td>${item.floor || '-'}ì¸µ</td>
                                    <td>${size}í‰</td>
                                    <td><span class="tag tag-${state}">${stateText}${date ? ' ' + date : ''}</span></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼
            if (totalPages > 1) {
                paginationEl.innerHTML = Array.from({length: totalPages}, (_, i) => i + 1)
                    .map(p => `<button onclick="goToPage(${p})" style="${p === page ? 'background:linear-gradient(135deg,#00d4ff,#7c3aed);' : 'background:rgba(255,255,255,0.1);'}">${p}</button>`)
                    .join('');
            } else {
                paginationEl.innerHTML = '';
            }
        }

        function goToPage(page) {
            currentPage = page;
            if (currentData && currentData.listings) {
                updateListingsTable(currentData.listings, page);
            }
        }

        function updateQuarterlyTable(items) {
            const container = document.getElementById('quarterlyTable');

            if (!items.length) {
                container.innerHTML = '<div class="empty-state">ë¶„ê¸°ë³„ ë°ì´í„° ì—†ìŒ</div>';
                return;
            }

            const fmt = (v) => v >= 10000 ? (v/10000).toFixed(1) + 'ì–µ' : Math.round(v).toLocaleString() + 'ë§Œ';

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ë¶„ê¸°</th>
                            <th>í‰ê·  ë³´ì¦ê¸ˆ</th>
                            <th>í‰ê·  ì›”ì„¸</th>
                            <th>í‰ë‹¹ê°€</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.slice(0, 10).map(item => {
                            // /10 ë³´ì •
                            const dep = item.avgDeposit / 10;
                            const rent = item.avgMonthlyRent / 10;
                            const price = item.avgAreaPrice / 10;
                            return `
                                <tr>
                                    <td>${item.quarter}</td>
                                    <td class="highlight">${fmt(dep)}</td>
                                    <td class="highlight-green">${Math.round(rent)}ë§Œ</td>
                                    <td>${price.toFixed(1)}ë§Œ/í‰</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // ============================================
        // ìœ í‹¸ë¦¬í‹°
        // ============================================

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.className = 'toast', 3000);
        }

        function exportCSV() {
            if (!currentData || !currentData.listings) {
                showToast('ë¨¼ì € ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            const headers = ['ì£¼ì†Œ', 'ë„ë¡œëª…ì£¼ì†Œ', 'ë³´ì¦ê¸ˆ(ë§Œì›)', 'ì›”ì„¸(ë§Œì›)', 'í‰ë‹¹ê°€(ì²œì›)', 'ê¶Œë¦¬ê¸ˆ(ë§Œì›)', 'ì¸µ', 'ìƒíƒœ'];
            const rows = currentData.listings.map(item => {
                const info = item.articleInfo || {};
                return [
                    item.address || '',
                    item.roadAddress || '',
                    info.avgDeposit || '',
                    info.avgMonthlyRent || '',
                    info.avgAreaPrice || '',
                    info.avgPremium || '',
                    info.floor || '',
                    info.state === 1 ? 'ê³µê°œ' : 'ê±°ë˜ì™„ë£Œ'
                ];
            });

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nemoapp_data_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
        }

        // ============================================
        // ë¡œì»¬ JSON ë°ì´í„° ë¡œë“œ (CORS ìš°íšŒ)
        // ============================================

        async function loadLocalData() {
            const btn = document.getElementById('fetchBtn');
            btn.disabled = true;
            btn.textContent = 'ë¡œë”© ì¤‘...';

            try {
                const response = await fetch('data/market_data.json');
                const data = await response.json();

                currentData = {
                    stats: data.stats,
                    listings: data.listings,
                    count: data.count,
                    coords: data.coords
                };

                // UI ì—…ë°ì´íŠ¸
                updateStats(data.stats, data.count);
                updateFloorChart(data.listings || []);  // ê°œë³„ ë§¤ë¬¼ ê¸°ì¤€ ê³„ì‚°
                updateBusinessChart(data.stats.businessItems || []);
                updateListingsTable(data.listings || []);
                updateQuarterlyTable(data.stats.complateItems || []);
                updateMap(data.listings || []);
                updateFilterStats(data.listings || []);

                showToast(`ë°ì´í„° ë¡œë“œ ì™„ë£Œ! (${data.area}, ${data.listings?.length || 0}ê°œ ë§¤ë¬¼)`, 'success');

            } catch (error) {
                showToast(`ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ë°ì´í„° ì¡°íšŒ';
            }
        }

        // ============================================
        // ì¸µ í•„í„°
        // ============================================

        function filterByFloor(floorType) {
            currentFloorFilter = floorType;
            currentPage = 1;

            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.floor === floorType);
            });

            if (currentData && currentData.listings) {
                const filtered = getFilteredListings();
                updateListingsTable(filtered, 1);
                updateFilterStats(filtered);
            }
        }

        function getFilteredListings() {
            if (!currentData || !currentData.listings) return [];

            // ê°œë³„ ë§¤ë¬¼ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§ í›„ ë‹¤ì‹œ buildings í˜•íƒœë¡œ ë°˜í™˜
            const filtered = [];
            currentData.listings.forEach(building => {
                const items = (building.items || []).filter(item => {
                    const floor = item.floor || 0;
                    switch (currentFloorFilter) {
                        case 'basement': return floor < 0;
                        case '1': return floor === 1;
                        case 'upper': return floor >= 2;
                        default: return true;
                    }
                });
                if (items.length > 0) {
                    filtered.push({ ...building, items });
                }
            });
            return filtered;
        }

        function updateFilterStats(listings) {
            const statsEl = document.getElementById('filterStats');
            const allItems = flattenItems(listings);

            if (!allItems.length) {
                statsEl.textContent = 'í•´ë‹¹ ì¡°ê±´ ë§¤ë¬¼ ì—†ìŒ';
                return;
            }

            // ê°œë³„ ë§¤ë¬¼ ê¸°ì¤€ í‰ê·  ê³„ì‚°
            const avgDep = allItems.reduce((s, i) => s + (i.deposit || 0), 0) / allItems.length;
            const avgRent = allItems.reduce((s, i) => s + (i.monthlyRent || 0), 0) / allItems.length;
            const avgPrice = allItems.reduce((s, i) => s + (i.areaPrice || 0), 0) / allItems.length;

            const fmtDep = avgDep >= 10000 ? (avgDep/10000).toFixed(1) + 'ì–µ' : Math.round(avgDep).toLocaleString() + 'ë§Œ';
            const completedCount = allItems.filter(i => i.state === 3).length;

            statsEl.textContent = `${allItems.length}ê±´ (ê±°ë˜ì™„ë£Œ ${completedCount}) | í‰ê·  ë³´ì¦ê¸ˆ ${fmtDep} / ì›”ì„¸ ${Math.round(avgRent)}ë§Œ / í‰ë‹¹ ${avgPrice.toFixed(1)}ë§Œ`;
        }

        // ============================================
        // ì§€ë„
        // ============================================

        function initMap() {
            if (map) return;

            map = L.map('map', {
                zoomControl: false
            }).setView([37.534, 127.067], 17);

            // ê¹”ë”í•œ ë‹¤í¬ íƒ€ì¼
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OSM &copy; CARTO',
                maxZoom: 19
            }).addTo(map);

            // ì¤Œ ì»¨íŠ¸ë¡¤ ì˜¤ë¥¸ìª½ ìœ„ì—
            L.control.zoom({ position: 'topright' }).addTo(map);
        }

        function updateMap(listings) {
            if (!map) initMap();

            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) map.removeLayer(layer);
            });

            if (!listings.length) return;

            // ë§ˆì»¤ ì¶”ê°€ (ê°œë³„ ë§¤ë¬¼ ë‹¨ìœ„)
            const markers = [];
            listings.forEach(building => {
                const lat = building.centerLatitude;
                const lng = building.centerLongitude;
                if (!lat || !lng) return;

                const addr = building.roadAddress || building.address;

                (building.items || []).forEach((item, idx) => {
                    const dep = item.deposit || 0;
                    const rent = item.monthlyRent || 0;
                    const fmtDep = dep >= 10000 ? (dep/10000).toFixed(1) + 'ì–µ' : Math.round(dep) + 'ë§Œ';
                    const floor = item.floor || 0;
                    const price = item.areaPrice || 0;

                    // ì¸µë³„ ìƒ‰ìƒ
                    let color = '#00d4ff';
                    if (floor < 0) color = '#f59e0b';
                    else if (floor === 1) color = '#10b981';
                    else if (floor >= 2) color = '#a855f7';

                    // ìƒíƒœë³„ íˆ¬ëª…ë„
                    const opacity = item.state === 1 ? 1 : 0.5;
                    const stateText = item.state === 1 ? 'ğŸŸ¢ ê´‘ê³ ì¤‘' : 'âšª ê±°ë˜ì™„ë£Œ';
                    const date = item.completionConfirmedDateUtc ? ' (' + item.completionConfirmedDateUtc.slice(0,10) + ')' : '';

                    // ê°™ì€ ê±´ë¬¼ ì—¬ëŸ¬ ë§¤ë¬¼ì€ ì‚´ì§ ìœ„ì¹˜ ì˜¤í”„ì…‹
                    const offset = idx * 0.00003;

                    const marker = L.circleMarker([lat + offset, lng + offset], {
                        radius: 10,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: opacity,
                        fillOpacity: opacity * 0.8
                    }).addTo(map);

                    marker.bindPopup(`
                        <div style="font-size:13px;line-height:1.6;">
                            <b style="color:#333;">${addr}</b><br>
                            <span style="color:#00d4ff;font-weight:600;">ë³´ì¦ê¸ˆ ${fmtDep}</span> /
                            <span style="color:#10b981;font-weight:600;">ì›”ì„¸ ${Math.round(rent)}ë§Œ</span><br>
                            <span style="color:#7c3aed;font-weight:600;">í‰ë‹¹ ${price.toFixed(1)}ë§Œ</span><br>
                            <span style="color:#666;">${floor}ì¸µ Â· ${stateText}${date}</span>
                        </div>
                    `, { className: 'custom-popup' });

                    markers.push(marker);
                });
            });

            // ì§€ë„ ë²”ìœ„ ì¡°ì •
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = function() {
            initMap();
            loadLocalData();
        };
    </script>
</body>
</html>
