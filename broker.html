<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µì¸ì¤‘ê°œì‚¬ í˜„í™© - ê´‘ì§„êµ¬</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        /* Navigation */
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .nav a {
            padding: 10px 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .nav a:hover, .nav a.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
        }
        h1 {
            font-size: 1.8rem;
            color: var(--text);
            margin-bottom: 10px;
            font-weight: 700;
        }
        .subtitle { color: var(--text-muted); font-size: 0.95rem; }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px;
            text-align: center;
        }
        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        .stat-card .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        .stat-card.highlight { border-color: var(--success); }
        .stat-card.highlight .value { color: var(--success); }

        /* Controls Row */
        .controls-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-size: 0.9rem;
            outline: none;
        }
        .search-box input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* Filter Buttons */
        .filter-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }
        .filter-btn.green.active {
            background: var(--success);
            border-color: var(--success);
            color: #fff;
        }
        .filter-btn.blue.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }
        .filter-btn.purple.active {
            background: #7c3aed;
            border-color: #7c3aed;
            color: #fff;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        /* Map */
        .map-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .map-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .map-info {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .map-info .count {
            color: var(--primary);
            font-weight: 600;
        }
        .selected-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 15px;
            min-height: 44px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }
        .selected-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(37,99,235,0.1);
            border: 1px solid var(--primary);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .selected-badge:hover {
            background: rgba(239,68,68,0.1);
            border-color: #ef4444;
            color: #ef4444;
        }
        .selected-badge .remove { font-size: 0.9rem; }
        .selected-badge.no-coords {
            background: rgba(239,68,68,0.1);
            border-color: #ef4444;
            color: #ef4444;
        }
        .no-selection {
            color: var(--text-muted);
            font-size: 0.8rem;
            padding: 5px 0;
        }
        #map { height: 450px; width: 100%; }

        /* Table */
        .table-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .table-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-scroll {
            flex: 1;
            max-height: 500px;
            overflow-y: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--bg);
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-muted);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:hover { background: var(--bg); }
        tr.expanded { background: rgba(37,99,235,0.05); }
        tr.selected { background: rgba(16,185,129,0.1); border-left: 3px solid var(--success); }
        tr.selected:hover { background: rgba(16,185,129,0.15); }

        /* Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-yes { background: rgba(37,99,235,0.1); color: var(--primary); }
        .badge-no { background: var(--bg); color: var(--text-muted); }
        .badge-years { background: rgba(245,158,11,0.1); color: var(--warning); }
        .badge-years.veteran { background: rgba(16,185,129,0.1); color: var(--success); }
        .badge-excellent { background: rgba(245,158,11,0.1); color: var(--warning); }

        /* Sortable Table */
        th.sortable { cursor: pointer; user-select: none; transition: color 0.2s; }
        th.sortable:hover { color: var(--primary); }
        th.sortable::after { content: ' â†•'; opacity: 0.3; }
        th.sortable.asc::after { content: ' â†‘'; opacity: 1; color: var(--primary); }
        th.sortable.desc::after { content: ' â†“'; opacity: 1; color: var(--primary); }

        /* Expandable Row */
        .broker-row { cursor: pointer; }
        .broker-detail {
            display: none;
            background: var(--bg);
            padding: 0;
        }
        .broker-detail.show { display: table-row; }
        .detail-content {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .detail-item {
            background: var(--card);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .detail-item .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .detail-item .value {
            font-size: 0.95rem;
            color: var(--text);
        }
        .staff-list {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        .staff-list h4 {
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .staff-item {
            display: inline-block;
            background: var(--card);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 6px;
            margin: 4px;
            font-size: 0.85rem;
        }
        .staff-item .role {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-left: 5px;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 30px;
        }

        /* Leaflet Custom */
        .leaflet-popup-content-wrapper {
            background: #fff;
            color: var(--text);
            border-radius: 12px;
        }
        .leaflet-popup-tip { background: #fff; }
        .popup-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
            color: var(--primary);
        }
        .popup-info { font-size: 0.85rem; line-height: 1.6; color: var(--text-muted); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="nav">
            <a href="index.html">ì‹¤ì‹œê°„ ì‹œì„¸</a>
            <a href="broker.html" class="active">ê³µì¸ì¤‘ê°œì‚¬</a>
            <a href="analysis.html">ì„ëŒ€ ë¶„ì„</a>
            <a href="report.html">ì „ëµ ë³´ê³ ì„œ</a>
        </nav>

        <!-- Header -->
        <header>
            <h1>ê´‘ì§„êµ¬ ê³µì¸ì¤‘ê°œì‚¬ í˜„í™©</h1>
            <p class="subtitle">ì„œìš¸ì‹œ ê´‘ì§„êµ¬ ë“±ë¡ ê³µì¸ì¤‘ê°œì‚¬ ì •ë³´ | ë°ì´í„° ì¶œì²˜: ì„œìš¸ì‹œ ë¶€ë™ì‚°ì •ë³´ê´‘ì¥</p>
        </header>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="value" id="totalCount">-</div>
                <div class="label">ì´ ë“±ë¡ ì¤‘ê°œì‚¬</div>
            </div>
            <div class="stat-card highlight">
                <div class="value" id="activeCount">-</div>
                <div class="label">ì˜ì—…ì¤‘</div>
            </div>
            <div class="stat-card">
                <div class="value" id="elctrnCount">-</div>
                <div class="label">ì „ìê³„ì•½ ê°€ëŠ¥</div>
            </div>
            <div class="stat-card">
                <div class="value" id="excellentCount">-</div>
                <div class="label">ìš°ìˆ˜ì—…ì²´</div>
            </div>
            <div class="stat-card">
                <div class="value" id="avgYears">-</div>
                <div class="label">í‰ê·  ì˜ì—…ê¸°ê°„</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-row">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ìƒí˜¸ëª…, ëŒ€í‘œì, ì£¼ì†Œë¡œ ê²€ìƒ‰...">
            </div>
            <div class="filter-group" id="dongFilter">
                <button class="filter-btn dong-btn active" data-dong="all">ì „ì²´</button>
                <button class="filter-btn dong-btn" data-dong="ìì–‘ë™">ìì–‘ë™</button>
                <button class="filter-btn dong-btn" data-dong="êµ¬ì˜ë™">êµ¬ì˜ë™</button>
                <button class="filter-btn dong-btn" data-dong="ì¤‘ê³¡ë™">ì¤‘ê³¡ë™</button>
                <button class="filter-btn dong-btn" data-dong="í™”ì–‘ë™">í™”ì–‘ë™</button>
                <button class="filter-btn dong-btn" data-dong="ê´‘ì¥ë™">ê´‘ì¥ë™</button>
                <button class="filter-btn dong-btn" data-dong="êµ°ìë™">êµ°ìë™</button>
                <button class="filter-btn dong-btn" data-dong="ëŠ¥ë™">ëŠ¥ë™</button>
            </div>
        </div>
        <div class="controls-row">
            <div class="filter-group">
                <button class="filter-btn years-btn active" data-filter="all">ì „ì²´</button>
                <button class="filter-btn years-btn green" data-filter="10+">10ë…„+</button>
                <button class="filter-btn years-btn blue" data-filter="5+">5ë…„+</button>
                <button class="filter-btn years-btn purple" data-filter="5-">5ë…„ ë¯¸ë§Œ</button>
                <button class="filter-btn years-btn" data-filter="excellent">ìš°ìˆ˜ì—…ì²´</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Map -->
            <div class="map-container">
                <div class="map-header">
                    <span>ğŸ“ ìœ„ì¹˜ ì§€ë„</span>
                    <div class="map-info">
                        ì„ íƒëœ ì¤‘ê°œì‚¬: <span class="count" id="selectedCount">0</span>ê°œ
                    </div>
                </div>
                <div class="selected-badges" id="selectedBadges">
                    <span class="no-selection">í…Œì´ë¸”ì—ì„œ ì¤‘ê°œì‚¬ë¥¼ í´ë¦­í•˜ë©´ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤</span>
                    <button onclick="clearAllMarkers()" style="margin-left:auto; padding:5px 10px; background:#ef4444; border:none; border-radius:5px; color:#fff; cursor:pointer;">ì „ì²´ ì‚­ì œ</button>
                </div>
                <div id="map"></div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <div class="table-header">
                    <span>ì¤‘ê°œì‚¬ ëª©ë¡ (í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°)</span>
                    <span id="displayCount" style="font-size: 0.85rem; color: #888;">-</span>
                </div>
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="dong">ë™</th>
                                <th class="sortable" data-sort="cmpNm">ìƒí˜¸ëª…</th>
                                <th class="sortable" data-sort="rdealerNm">ëŒ€í‘œì</th>
                                <th class="sortable" data-sort="years" data-type="number">ì˜ì—…ê¸°ê°„</th>
                                <th class="sortable" data-sort="staffCount" data-type="number">ì†Œì†</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="brokerTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>ê³µì¸ì¤‘ê°œì‚¬ ì •ë³´ ëŒ€ì‹œë³´ë“œ | DOTS Project</p>
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let allBrokers = {};  // ë™ë³„ ë°ì´í„°
        let brokers = [];     // í˜„ì¬ ì„ íƒëœ ë™ì˜ ë°ì´í„°
        let filteredBrokers = [];
        let map;
        let markers = {};     // sysRegno -> marker ë§¤í•‘
        let selectedBrokers = new Set();  // ì„ íƒëœ ì¤‘ê°œì‚¬ sysRegno
        let currentSort = { field: null, direction: 'asc' };
        let currentFilter = 'all';
        let currentDong = 'all';
        let expandedRow = null;

        const DONGS = ['ê´‘ì¥ë™', 'êµ¬ì˜ë™', 'êµ°ìë™', 'ëŠ¥ë™', 'ìì–‘ë™', 'ì¤‘ê³¡ë™', 'í™”ì–‘ë™'];

        // ì˜ì—…ê¸°ê°„ ê³„ì‚°
        function calcYears(regDate) {
            if (!regDate || regDate.length !== 8) return null;
            const year = parseInt(regDate.substring(0, 4));
            const month = parseInt(regDate.substring(4, 6));
            const day = parseInt(regDate.substring(6, 8));
            const reg = new Date(year, month - 1, day);
            const now = new Date();
            const diff = (now - reg) / (1000 * 60 * 60 * 24 * 365);
            return Math.round(diff * 10) / 10;
        }

        // ë°ì´í„° ë¡œë“œ (ë™ë³„ íŒŒì¼)
        async function loadData() {
            try {
                // ëª¨ë“  ë™ ë°ì´í„° ë³‘ë ¬ ë¡œë“œ
                const promises = DONGS.map(dong =>
                    fetch(`data/brokers/${dong}.json`).then(r => r.json())
                );
                const results = await Promise.all(promises);

                let totalCount = 0;
                results.forEach((data, i) => {
                    allBrokers[data.dong] = data.brokers.map(b => ({
                        ...b,
                        dong: data.dong,
                        years: calcYears(b.regDate)
                    }));
                    totalCount += data.count;
                });

                // ì „ì²´ ë°ì´í„° í•©ì¹˜ê¸°
                brokers = Object.values(allBrokers).flat();
                filteredBrokers = [...brokers];

                updateStats(totalCount);
                renderTable(filteredBrokers);
                initMap();
                initSorting();
                initFilters();
                initDongFilters();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(totalCount) {
            document.getElementById('totalCount').textContent = totalCount.toLocaleString();
            document.getElementById('activeCount').textContent = brokers.filter(b => b.stsGbn === 'ì˜ì—…ì¤‘').length;
            document.getElementById('elctrnCount').textContent = brokers.filter(b => b.elctrnCntrctYn === 'Y').length;
            document.getElementById('excellentCount').textContent = brokers.filter(b => b.exclncYn === 'Y').length;

            const validYears = brokers.filter(b => b.years !== null).map(b => b.years);
            const avgYears = validYears.length > 0
                ? (validYears.reduce((a, b) => a + b, 0) / validYears.length).toFixed(1)
                : '-';
            document.getElementById('avgYears').textContent = avgYears + 'ë…„';
        }

        // í…Œì´ë¸” ë Œë”ë§
        function renderTable(data) {
            const tbody = document.getElementById('brokerTable');
            tbody.innerHTML = data.map((broker, idx) => {
                const yearsClass = broker.years >= 10 ? 'veteran' : '';
                const yearsText = broker.years !== null ? broker.years + 'ë…„' : '-';
                const staffText = broker.staffCount || 0;
                const isExcellent = broker.exclncYn === 'Y';
                const hasElectronic = broker.elctrnCntrctYn === 'Y';

                // ìƒíƒœ ë±ƒì§€ë“¤
                let statusBadges = '';
                if (isExcellent) statusBadges += '<span class="status-badge badge-excellent">ìš°ìˆ˜</span> ';
                if (hasElectronic) statusBadges += '<span class="status-badge badge-yes">ì „ì</span>';
                if (!statusBadges) statusBadges = '<span class="status-badge badge-no">-</span>';

                // ì†Œì†ì¸ì› ìƒì„¸
                const staffList = broker.staffList || [];
                const staffHtml = staffList.length > 0
                    ? staffList.map(s => {
                        const role = s.V_POS_GBN === '01' ? 'ëŒ€í‘œ' : (s.V_RDEALER_GBN === '2' ? 'ê³µì¸ì¤‘ê°œì‚¬' : 'ì¤‘ê°œë³´ì¡°ì›');
                        return `<div class="staff-item">${s.V_RDEALER_NM}<span class="role">${role}</span></div>`;
                    }).join('')
                    : '<div style="color:#888;">ì •ë³´ ì—†ìŒ</div>';

                return `
                <tr class="broker-row" data-idx="${idx}">
                    <td style="font-size: 0.8rem; color: #888;">${broker.dong || '-'}</td>
                    <td>
                        <div style="font-weight: 600; margin-bottom: 3px;">${broker.cmpNm}</div>
                        <div style="font-size: 0.75rem; color: #666;">${broker.address.substring(0, 20)}...</div>
                    </td>
                    <td>${broker.rdealerNm}</td>
                    <td><span class="status-badge badge-years ${yearsClass}">${yearsText}</span></td>
                    <td style="text-align: center;">${staffText}</td>
                    <td>${statusBadges}</td>
                </tr>
                <tr class="broker-detail" data-idx="${idx}">
                    <td colspan="6">
                        <div class="detail-content">
                            <div class="detail-item">
                                <div class="label">ë“±ë¡ë²ˆí˜¸</div>
                                <div class="value">${broker.raRegno}</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">ë“±ë¡ì¼</div>
                                <div class="value">${broker.regDate ? broker.regDate.substring(0,4)+'-'+broker.regDate.substring(4,6)+'-'+broker.regDate.substring(6,8) : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">ì „í™”ë²ˆí˜¸</div>
                                <div class="value">${broker.telno?.trim() || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">ì „ìê³„ì•½</div>
                                <div class="value">${hasElectronic ? 'ê°€ëŠ¥' : 'ë¶ˆê°€'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">ë³´ì¦ë³´í—˜</div>
                                <div class="value">${broker.guarantee === 'ìœ ' ? 'ê°€ì…' : '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">ìš°ìˆ˜ì—…ì²´</div>
                                <div class="value">${isExcellent ? 'ì¸ì¦' : '-'}</div>
                            </div>
                        </div>
                        <div class="staff-list">
                            <h4>ì†Œì† ì¤‘ê°œì¸ (${staffList.length}ëª…)</h4>
                            ${staffHtml}
                        </div>
                    </td>
                </tr>
            `}).join('');

            // í´ë¦­ ì´ë²¤íŠ¸ - ì§€ë„ í† ê¸€
            document.querySelectorAll('.broker-row').forEach(row => {
                row.addEventListener('click', async function(e) {
                    const idx = this.dataset.idx;
                    const broker = filteredBrokers[idx];
                    const rowEl = this;

                    // ë¡œë”© í‘œì‹œ
                    rowEl.style.opacity = '0.5';

                    // ì§€ë„ì— í† ê¸€ (await í•„ìš”)
                    await toggleBrokerOnMap(broker);

                    // ë¡œë”© í•´ì œ
                    rowEl.style.opacity = '1';

                    // í–‰ ì„ íƒ ìŠ¤íƒ€ì¼
                    if (selectedBrokers.has(broker.sysRegno)) {
                        rowEl.classList.add('selected');
                    } else {
                        rowEl.classList.remove('selected');
                    }
                });
            });

            // ë”ë¸”í´ë¦­ìœ¼ë¡œ ìƒì„¸ë³´ê¸°
            document.querySelectorAll('.broker-row').forEach(row => {
                row.addEventListener('dblclick', function() {
                    const idx = this.dataset.idx;
                    const detailRow = document.querySelector(`.broker-detail[data-idx="${idx}"]`);

                    // ì´ì „ í™•ì¥ëœ í–‰ ë‹«ê¸°
                    if (expandedRow && expandedRow !== detailRow) {
                        expandedRow.classList.remove('show');
                        expandedRow.previousElementSibling.classList.remove('expanded');
                    }

                    // í† ê¸€
                    detailRow.classList.toggle('show');
                    this.classList.toggle('expanded');
                    expandedRow = detailRow.classList.contains('show') ? detailRow : null;
                });
            });

            // ì´ë¯¸ ì„ íƒëœ í–‰ ìŠ¤íƒ€ì¼ ë³µì›
            updateTableRowStyles();

            document.getElementById('displayCount').textContent = `${data.length}ê°œ í‘œì‹œ`;
        }

        // ë™ í•„í„° ê¸°ëŠ¥
        function initDongFilters() {
            document.querySelectorAll('.dong-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.dong-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentDong = this.dataset.dong;

                    // ë™ë³„ ë°ì´í„° ì„ íƒ
                    if (currentDong === 'all') {
                        brokers = Object.values(allBrokers).flat();
                    } else {
                        brokers = allBrokers[currentDong] || [];
                    }

                    applyFilters();
                    updateStats(brokers.length);
                });
            });
        }

        // ì˜ì—…ê¸°ê°„ í•„í„° ê¸°ëŠ¥
        function initFilters() {
            document.querySelectorAll('.years-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.years-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    applyFilters();
                });
            });
        }

        function applyFilters() {
            const query = document.getElementById('searchInput').value.toLowerCase();

            filteredBrokers = brokers.filter(b => {
                // ê²€ìƒ‰ í•„í„°
                const matchSearch = b.cmpNm.toLowerCase().includes(query) ||
                    b.rdealerNm.toLowerCase().includes(query) ||
                    b.address.toLowerCase().includes(query);

                if (!matchSearch) return false;

                // ì˜ì—…ê¸°ê°„ í•„í„°
                if (currentFilter === '10+') return b.years >= 10;
                if (currentFilter === '5+') return b.years >= 5 && b.years < 10;
                if (currentFilter === '5-') return b.years !== null && b.years < 5;
                if (currentFilter === 'excellent') return b.exclncYn === 'Y';
                return true;
            });

            renderTable(filteredBrokers);
        }

        // ì •ë ¬ ê¸°ëŠ¥
        function initSorting() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.dataset.sort;
                    const isNumber = th.dataset.type === 'number';

                    if (currentSort.field === field) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.field = field;
                        currentSort.direction = 'asc';
                    }

                    filteredBrokers.sort((a, b) => {
                        let valA = a[field];
                        let valB = b[field];

                        if (valA === null || valA === undefined) valA = isNumber ? -Infinity : '';
                        if (valB === null || valB === undefined) valB = isNumber ? -Infinity : '';

                        if (isNumber) {
                            return currentSort.direction === 'asc' ? valA - valB : valB - valA;
                        } else {
                            return currentSort.direction === 'asc'
                                ? String(valA).localeCompare(String(valB))
                                : String(valB).localeCompare(String(valA));
                        }
                    });

                    document.querySelectorAll('th.sortable').forEach(t => t.classList.remove('asc', 'desc'));
                    th.classList.add(currentSort.direction);
                    renderTable(filteredBrokers);
                });
            });
        }

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            map = L.map('map').setView([37.538, 127.082], 14);

            // CartoDB Voyager - ê¹”ë”í•œ ëª¨ë˜ ìŠ¤íƒ€ì¼
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap, &copy; CARTO',
                maxZoom: 19
            }).addTo(map);
        }

        // ì¤‘ê°œì‚¬ ì„ íƒ í† ê¸€
        async function toggleBrokerOnMap(broker) {
            const id = broker.sysRegno;
            console.log('í† ê¸€:', id, 'í˜„ì¬ ì„ íƒë¨?', selectedBrokers.has(id));

            if (selectedBrokers.has(id)) {
                // ì œê±°
                console.log('ë§ˆì»¤ ì œê±° ì‹œë„, markers[id]:', markers[id]);
                selectedBrokers.delete(id);
                if (markers[id]) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                    console.log('ë§ˆì»¤ ì œê±° ì™„ë£Œ');
                }
                updateSelectedBadges();
                fitMapToBounds();
            } else {
                // ì¶”ê°€
                selectedBrokers.add(id);
                updateSelectedBadges();

                // ì¢Œí‘œ ì—†ìœ¼ë©´ ì§€ì˜¤ì½”ë”©
                if (!broker.lat || !broker.lng) {
                    const coords = await geocodeAddress(broker.address);
                    if (coords) {
                        broker.lat = coords.lat;
                        broker.lng = coords.lng;
                    }
                }

                addMarkerForBroker(broker);
                updateSelectedBadges();
                fitMapToBounds();
            }
        }

        // ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜ (Nominatim)
        async function geocodeAddress(address) {
            try {
                // ì£¼ì†Œ ì •ì œ - ìƒì„¸ì£¼ì†Œ ì œê±°
                let cleanAddr = address
                    .replace(/\(.*?\)/g, '')           // ê´„í˜¸ ë‚´ìš© ì œê±°
                    .replace(/\d+ì¸µ.*$/g, '')          // ì¸µ ì´í›„ ì œê±°
                    .replace(/\s+\d+í˜¸.*$/g, '')       // í˜¸ ì´í›„ ì œê±°
                    .replace(/ìƒê°€ë™.*$/g, '')          // ìƒê°€ë™ ì´í›„ ì œê±°
                    .replace(/\s+[ê°€-í£]+ë™\s+\d+.*$/g, '') // XXë™ 123 í˜•íƒœ ì œê±°
                    .trim();
                console.log('ì§€ì˜¤ì½”ë”© ì‹œì‘:', cleanAddr);

                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cleanAddr)}&countrycodes=kr&limit=1`;

                const response = await fetch(url, {
                    headers: { 'User-Agent': 'BrokerDashboard/1.0' }
                });
                const data = await response.json();
                console.log('ì§€ì˜¤ì½”ë”© ê²°ê³¼:', data);

                if (data && data.length > 0) {
                    const coords = {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                    console.log('ì¢Œí‘œ ë³€í™˜ ì„±ê³µ:', coords);
                    return coords;
                }
                console.log('ì¢Œí‘œ ì°¾ê¸° ì‹¤íŒ¨');
            } catch (error) {
                console.error('ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨:', error);
            }
            return null;
        }

        // ë§ˆì»¤ ì¶”ê°€
        function addMarkerForBroker(broker) {
            console.log('ë§ˆì»¤ ì¶”ê°€ ì‹œë„:', broker.cmpNm, broker.lat, broker.lng);
            if (!broker.lat || !broker.lng) {
                console.log('ì¢Œí‘œ ì—†ìŒ - ë§ˆì»¤ ì¶”ê°€ ì‹¤íŒ¨');
                return false;
            }

            let markerColor = '#7c3aed';
            if (broker.years >= 10) markerColor = '#10b981';
            else if (broker.years >= 5) markerColor = '#00d4ff';

            const marker = L.circleMarker([broker.lat, broker.lng], {
                radius: 10,
                fillColor: markerColor,
                color: '#fff',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.9
            });

            const yearsText = broker.years !== null ? broker.years.toFixed(1) + 'ë…„' : '-';
            marker.bindPopup(`
                <div class="popup-title">${broker.cmpNm}</div>
                <div class="popup-info">
                    <div><strong>ëŒ€í‘œ:</strong> ${broker.rdealerNm}</div>
                    <div><strong>ì˜ì—…ê¸°ê°„:</strong> ${yearsText}</div>
                    <div><strong>ì†Œì†ì¸ì›:</strong> ${broker.staffCount || 0}ëª…</div>
                    <div><strong>ì „ìê³„ì•½:</strong> ${broker.elctrnCntrctYn === 'Y' ? 'ê°€ëŠ¥' : 'ë¶ˆê°€'}</div>
                    <div><strong>ì£¼ì†Œ:</strong> ${broker.address}</div>
                </div>
            `);

            marker.addTo(map);
            markers[broker.sysRegno] = marker;
            return true;
        }

        // ì„ íƒëœ ë±ƒì§€ ì—…ë°ì´íŠ¸
        function updateSelectedBadges() {
            const container = document.getElementById('selectedBadges');
            const countEl = document.getElementById('selectedCount');

            countEl.textContent = selectedBrokers.size;

            if (selectedBrokers.size === 0) {
                container.innerHTML = '<span class="no-selection">í…Œì´ë¸”ì—ì„œ ì¤‘ê°œì‚¬ë¥¼ í´ë¦­í•˜ë©´ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤</span>';
                return;
            }

            const badges = [];
            selectedBrokers.forEach(id => {
                const broker = brokers.find(b => b.sysRegno === id);
                if (broker) {
                    const hasCoords = broker.lat && broker.lng;
                    badges.push(`
                        <div class="selected-badge ${!hasCoords ? 'no-coords' : ''}"
                             onclick="removeBrokerFromMap('${id}')"
                             title="${hasCoords ? 'í´ë¦­í•˜ì—¬ ì œê±°' : 'ì¢Œí‘œ ì—†ìŒ'}">
                            ${broker.cmpNm.substring(0, 10)}${broker.cmpNm.length > 10 ? '..' : ''}
                            ${!hasCoords ? 'ğŸ“âŒ' : ''}
                            <span class="remove">Ã—</span>
                        </div>
                    `);
                }
            });

            container.innerHTML = badges.join('');
        }

        // ì§€ë„ì—ì„œ ì œê±°
        function removeBrokerFromMap(id) {
            selectedBrokers.delete(id);
            if (markers[id]) {
                map.removeLayer(markers[id]);
                delete markers[id];
            }
            updateSelectedBadges();
            updateTableRowStyles();
            fitMapToBounds();
        }

        // í…Œì´ë¸” í–‰ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        function updateTableRowStyles() {
            document.querySelectorAll('.broker-row').forEach(row => {
                const idx = row.dataset.idx;
                const broker = filteredBrokers[idx];
                if (broker && selectedBrokers.has(broker.sysRegno)) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });
        }

        // ì§€ë„ ë²”ìœ„ ë§ì¶”ê¸°
        function fitMapToBounds() {
            const markerList = Object.values(markers);
            if (markerList.length === 0) {
                map.setView([37.538, 127.082], 14);
            } else if (markerList.length === 1) {
                const latlng = markerList[0].getLatLng();
                map.setView(latlng, 16);
            } else {
                const group = L.featureGroup(markerList);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // ê²€ìƒ‰
        document.getElementById('searchInput').addEventListener('input', function() {
            applyFilters();
        });

        // ì „ì²´ ë§ˆì»¤ ì‚­ì œ
        function clearAllMarkers() {
            console.log('ì „ì²´ ë§ˆì»¤ ì‚­ì œ');
            Object.values(markers).forEach(marker => {
                map.removeLayer(marker);
            });
            markers = {};
            selectedBrokers.clear();
            updateSelectedBadges();
            updateTableRowStyles();
            map.setView([37.538, 127.082], 14);
        }

        // ì´ˆê¸°í™”
        loadData();
    </script>
</body>
</html>
